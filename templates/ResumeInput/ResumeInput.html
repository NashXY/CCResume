<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>简历录入</title>
	<style>
		body { font-family: Arial, sans-serif; background: #f3f4f6; margin:0; padding:20px }
		.container { max-width:900px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.06) }
		.row { display:flex; gap:16px; }
		.col { flex:1 }
		label { display:block; margin:10px 0 6px }
		input[type=text], input[type=email], input[type=number], textarea { width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:6px }
		textarea { min-height:120px }
		.section { margin-top:14px }
		.files-drop { margin-top:10px; border:2px dashed #cbd5e1; border-radius:8px; padding:18px; text-align:center; background:#fafafa }
		.files-drop.dragover { border-color:#2563eb; background:#f0f8ff }
		.file-list { margin-top:10px; text-align:left }
		button { margin-top:14px; padding:10px 14px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer }
		.hint { color:#6b7280; font-size:13px }
	</style>
</head>
<body>
	<div class="container">
		<h2>简历录入</h2>
		<form id="resumeForm" method="post" action="/ResumeInput" enctype="multipart/form-data">
			{% if success %}
			<div style="padding:10px; background:#ecfdf5; border:1px solid #10b981; color:#065f46; border-radius:6px; margin-bottom:10px">提交成功</div>
			{% endif %}
			{% if error %}
			<div style="padding:10px; background:#fff1f2; border:1px solid #fb7185; color:#7f1d1d; border-radius:6px; margin-bottom:10px">上传的文件格式不被允许，请上传 PDF 或 DOC/DOCX 文件</div>
			{% endif %}
			<label for="name">姓名</label>
			<input id="name" name="name" type="text" placeholder="请输入姓名" />

			<label for="age">年龄</label>
			<input id="age" name="age" type="number" min="0" placeholder="年龄" />

			<label for="contact">联系方式</label>
			<input id="contact" name="contact" type="text" placeholder="手机或电话" />

			<label for="email">邮箱</label>
			<input id="email" name="email" type="email" placeholder="example@mail.com" />

			<label for="sex">性别</label>
			<select id="sex" name="sex">
				<option value="">-- 请选择 --</option>
				<option value="男">男</option>
				<option value="女">女</option>
				<option value="other">其他</option>
			</select>

			<div class="section">
				<h3>职业经历</h3>
				<label for="career">职业经历描述</label>
				<textarea id="career" name="career" placeholder="时间 - 职位 - 工作内容（多行）"></textarea>
			</div>

			<div class="section">
			<!-- 项目经历区已移除，项目内容将合并到职业经历中 -->


			<div class="section">
				<h3>教育经历</h3>
				<label for="edu">教育经历</label>
				<textarea id="edu" name="edu" placeholder="学校 - 专业 - 时间（多行）"></textarea>
			</div>

			<div class="section">
				<label>上传简历或附件（支持拖拽）</label>
				<div id="dropZone" class="files-drop">
					<div class="hint">将文件拖到此处，或点击选择文件</div>
					<input id="fileInput" type="file" name="file" accept=".pdf,.doc,.docx" style="display:none" />
					<div id="fileList" class="file-list"></div>
				</div>
			</div>

			<button type="submit">提交</button>
		</form>
	</div>

	<script>
		const dropZone = document.getElementById('dropZone');
		const fileInput = document.getElementById('fileInput');
		const fileList = document.getElementById('fileList');

		dropZone.addEventListener('click', () => fileInput.click());

		fileInput.addEventListener('change', () => {
			updateList(Array.from(fileInput.files));
		});

		dropZone.addEventListener('dragover', (e) => {
			e.preventDefault();
			dropZone.classList.add('dragover');
		});
		dropZone.addEventListener('dragleave', (e) => {
			dropZone.classList.remove('dragover');
		});
		dropZone.addEventListener('drop', async (e) => {
			e.preventDefault();
			dropZone.classList.remove('dragover');
			const dtFiles = Array.from(e.dataTransfer.files);
			// 只取第一个文件（单文件上传）
			const first = dtFiles[0] ? dtFiles.slice(0,1) : [];
			try {
				const dataTransfer = new DataTransfer();
				if(first[0]) dataTransfer.items.add(first[0]);
				fileInput.files = dataTransfer.files;
			} catch (err) {
				console.warn('Cannot assign files to file input programmatically', err);
			}
			updateList(first);

			// 使用 AJAX 将整个表单（包括文件）提交到 /ResumeInput/ajax
			if(first.length > 0){
				const formEl = document.getElementById('resumeForm');
				const fd = new FormData(formEl);
				// 可选：显示上传中提示
				const status = document.createElement('div');
				status.textContent = '上传中...';
				fileList.appendChild(status);
				try{
					const resp = await fetch('/ResumeInput/ajax', { method: 'POST', body: fd });
					let data = null;
					const ct = resp.headers.get('content-type') || '';
					if (ct.includes('application/json')) {
						data = await resp.json();
					} else {
						// 非 JSON（可能是 HTML 错误页面），把文本作为错误信息
						const txt = await resp.text();
						status.textContent = '';
						const errEl = document.createElement('div');
						errEl.style.color = '#b91c1c';
						errEl.textContent = '服务器返回非 JSON 响应：' + (txt.slice(0,200) + (txt.length>200? '...':''));
						fileList.appendChild(errEl);
						return;
					}

					// 现在 data 已经被解析，安全地访问 parsed
					let parsed = null;
					if (data && data.parsed) parsed = data.parsed;
					else if (data && data.texts && data.texts.length>0) parsed = data.texts[0];

					if (parsed && typeof parsed === 'object'){
						// 填姓名、年龄、联系方式、邮箱
						const nameEl = document.getElementById('name');
						const ageEl = document.getElementById('age');
						const contactEl = document.getElementById('contact');
						const emailEl = document.getElementById('email');
						const sexEl = document.getElementById('sex');
						if(nameEl && parsed.name) nameEl.value = parsed.name;
						if(ageEl && parsed.age) ageEl.value = parsed.age;
						if(contactEl && parsed.phone) contactEl.value = parsed.phone;
						if(emailEl && parsed.email) emailEl.value = parsed.email;
						if(sexEl && parsed.sex){
							const s = (parsed.sex + '').toString().trim();
							if(/^(男|女)$/.test(s)){
								sexEl.value = s;
							} else if(/^male$/i.test(s)){
								sexEl.value = '男';
							} else if(/^female$/i.test(s)){
								sexEl.value = '女';
							} else {
								sexEl.value = 'other';
								sexEl.title = s; // 将原始值放到 title，便于人工查看
							}
						}

						// parsed.careers -> 填到职业经历 textarea（追加或覆盖）
						const careerEl = document.getElementById('career');
						if(careerEl && parsed.careers && Array.isArray(parsed.careers) && parsed.careers.length>0){
							const joinedCareer = parsed.careers.join('\n\n-----\n\n');
							if(careerEl.value && careerEl.value.trim().length>0) careerEl.value = careerEl.value + '\n\n' + joinedCareer;
							else careerEl.value = joinedCareer;
						}

						// 注意：项目经历 (projects) 已合并到职业经历 (careers)，因此不再填充单独的 projects 区域

						// education -> 填到教育经历 textarea
						const eduEl = document.getElementById('edu');
						if(eduEl && parsed.education && Array.isArray(parsed.education) && parsed.education.length>0){
							const joinedEdu = parsed.education.join('\n\n');
							if(eduEl.value && eduEl.value.trim().length>0) eduEl.value = eduEl.value + '\n\n' + joinedEdu;
							else eduEl.value = joinedEdu;
						}
					}
					if(resp.ok && data.ok){
						const okEl = document.createElement('div');
						okEl.style.color = '#065f46';
						okEl.textContent = '上传成功: ' + (data.filenames ? data.filenames.join(', ') : first[0].name);
						fileList.appendChild(okEl);
						// 如果后端返回了解析文本（texts），把它们填入工作经历 textarea
						if(data.texts && data.texts.length > 0){
							const careerEl = document.getElementById('career');
							const joined = data.texts.filter(Boolean).join('\n\n-----\n\n');
							// 将解析文本追加到职业经历（若需要覆盖改为 = joined）
							if(careerEl){
								if(careerEl.value && careerEl.value.trim().length > 0){
									careerEl.value = careerEl.value + '\n\n' + joined;
								} else {
									careerEl.value = joined;
								}
							}
						}
					} else {
						const errEl = document.createElement('div');
						errEl.style.color = '#b91c1c';
						errEl.textContent = '上传失败: ' + (data.error || resp.statusText || '未知错误');
						fileList.appendChild(errEl);
					}
				}catch(err){
					status.textContent = '';
					const errEl = document.createElement('div');
					errEl.style.color = '#b91c1c';
					errEl.textContent = '上传请求失败: ' + err.message;
					fileList.appendChild(errEl);
				}
			}
		});

		const submitBtn = document.querySelector('button[type="submit"]');

		function updateList(files){
			const allowed = ['.pdf','.doc','.docx'];
			if(!files || files.length === 0){ fileList.innerHTML = '<div class="hint">未选择文件</div>'; submitBtn.disabled = false; return; }
			const f = files[0];
			fileList.innerHTML = '';
			const el = document.createElement('div');
			el.textContent = f.name + ' (' + Math.round(f.size/1024) + ' KB)';
			fileList.appendChild(el);
			const idx = f.name.lastIndexOf('.');
			const ext = idx >= 0 ? f.name.slice(idx).toLowerCase() : '';
			if(!allowed.includes(ext)){
				const warn = document.createElement('div');
				warn.style.color = '#b91c1c';
				warn.style.marginTop = '8px';
				warn.textContent = '文件格式不被允许：' + f.name;
				fileList.appendChild(warn);
				submitBtn.disabled = true;
			} else {
				submitBtn.disabled = false;
			}
		}

		// 初始化为空提示
		updateList([]);
	</script>
</body>
</html>

